@model Umbraco13.Models.FundsTableViewModel

@{
    var fundsData = System.Text.Json.JsonSerializer.Serialize(Model.Funds);
}

<div id="funds-table-container" style="margin: 40px auto 0 auto; width: 70%; max-width: 100%;">
    <!-- Download Buttons -->
    <div style="margin-bottom: 15px; text-align: right;">
        <a href="#" id="download-pdf" class="btn btn-danger" style="text-decoration: none; margin-right: 10px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-pdf" viewBox="0 0 16 16" style="margin-right: 5px; vertical-align: text-bottom;">
                <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
            </svg>
            Download PDF
        </a>
        <a href="#" id="download-csv" class="btn btn-primary" style="text-decoration: none; margin-right: 10px; display: none;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-csv" viewBox="0 0 16 16" style="margin-right: 5px; vertical-align: text-bottom;">
                <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
            </svg>
            Download CSV
        </a>
        <a href="#" id="download-excel-free" class="btn btn-success" style="text-decoration: none; margin-right: 10px; display: none;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-excel" viewBox="0 0 16 16" style="margin-right: 5px; vertical-align: text-bottom;">
                <path d="M5.884 6.68a.5.5 0 1 0-.768.64L7.349 10l-2.233 2.68a.5.5 0 0 0 .768.64L8 10.78l2.116 2.54a.5.5 0 0 0 .768-.641L8.651 10l2.233-2.68a.5.5 0 0 0-.768-.64L8 9.22 5.884 6.68z"/>
                <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
            </svg>
            Download Excel (Free)
        </a>
        <a href="#" id="download-excel-epplus" class="btn btn-success" style="text-decoration: none; display: none;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-excel" viewBox="0 0 16 16" style="margin-right: 5px; vertical-align: text-bottom;">
                <path d="M5.884 6.68a.5.5 0 1 0-.768.64L7.349 10l-2.233 2.68a.5.5 0 0 0 .768.64L8 10.78l2.116 2.54a.5.5 0 0 0 .768-.641L8.651 10l2.233-2.68a.5.5 0 0 0-.768-.64L8 9.22 5.884 6.68z"/>
                <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
            </svg>
            Download Excel (EPPlus)
        </a>
        <a href="#" id="download-excel-generic" class="btn btn-success" style="text-decoration: none;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-excel" viewBox="0 0 16 16" style="margin-right: 5px; vertical-align: text-bottom;">
                <path d="M5.884 6.68a.5.5 0 1 0-.768.64L7.349 10l-2.233 2.68a.5.5 0 0 0 .768.64L8 10.78l2.116 2.54a.5.5 0 0 0 .768-.641L8.651 10l2.233-2.68a.5.5 0 0 0-.768-.64L8 9.22 5.884 6.68z"/>
                <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
            </svg>
            Download Excel (Generic)
        </a>
    </div>

    @if (Model.Funds != null && Model.Funds.Count > 0)
    {
        <div class="table-responsive">
            <table class="table table-hover" id="funds-table">
                <thead class="table-light">
                    <tr>
                        <th class="sortable-column" data-column="FundName" style="cursor: pointer;">
                            Fund Name <span class="sort-indicator"></span>
                        </th>
                        <th class="sortable-column text-center" data-column="TickerCode" style="cursor: pointer;">
                            Ticker Code <span class="sort-indicator"></span>
                        </th>
                        <th class="sortable-column text-center" data-column="NavPrice" style="cursor: pointer;">
                            NAV Price <span class="sort-indicator"></span>
                        </th>
                        <th class="sortable-column text-center" data-column="MarketPrice" style="cursor: pointer;">
                            Market Price <span class="sort-indicator"></span>
                        </th>
                        <th class="sortable-column text-center" data-column="HoldInTrust" style="cursor: pointer;">
                            Hold In Trust <span class="sort-indicator"></span>
                        </th>
                    </tr>
                </thead>
                <tbody id="funds-table-body">
                    <!-- Data rows will be populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Pagination Controls -->
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div>
                <span id="pagination-info">Showing 1-10 of @Model.TotalItems entries</span>
            </div>
            <nav aria-label="Page navigation">
                <ul class="pagination mb-0" id="pagination-controls">
                    <!-- Pagination buttons will be populated by JavaScript -->
                </ul>
            </nav>
        </div>

        <!-- Page Size Selector -->
        <div class="mt-3 text-end">
            <label>Show
                <select id="page-size-select" class="form-select form-select-sm d-inline-block" style="width: auto;">
                    <option value="5">5</option>
                    <option value="10" selected>10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
                entries per page
            </label>
        </div>
    }
    else
    {
        <p>No funds data available.</p>
    }
</div>

<style>
.sortable-column:hover {
    background-color: #f0f0f0 !important;
}

.sort-indicator::after {
    content: '⇅';
    margin-left: 5px;
    opacity: 0.3;
}

.sort-asc .sort-indicator::after {
    content: '↑';
    opacity: 1;
}

.sort-desc .sort-indicator::after {
    content: '↓';
    opacity: 1;
}

.pagination .page-link {
    cursor: pointer;
}

.pagination .page-item.disabled .page-link {
    cursor: not-allowed;
}
</style>

<script>
// Data and state
let API_KEY = '';
let currentTokenVersion = '';
let allFunds = @Html.Raw(fundsData);
let currentPage = 1;
let pageSize = 10;
let sortColumn = 'FundName';
let sortDirection = 'asc';

// Fetch API key from server
function fetchApiKey() {
    return fetch('/funds/api-key')
        .then(response => response.json())
        .then(data => {
            API_KEY = data.apiKey;
            return API_KEY;
        })
        .catch(error => {
            console.error('Error fetching API key:', error);
            return '';
        });
}

// Update download links with new tokens
function updateDownloadLinks(tokens) {
    document.getElementById('download-pdf').href = '/funds/exporttopdf?token=' + tokens.pdf;
    document.getElementById('download-csv').href = '/funds/exporttocsv?token=' + tokens.csv;
    document.getElementById('download-excel-free').href = '/funds/exporttoexcel-free?token=' + tokens.excel;
    document.getElementById('download-excel-epplus').href = '/funds/exporttoexcel?token=' + tokens.excelEpPlus;
    document.getElementById('download-excel-generic').href = '/funds/exporttoexcel-generic?token=' + tokens.excelGeneric;
    console.log('Download links updated with new tokens, version:', tokens.version);
}

// Fetch download tokens and update links
function fetchAndUpdateTokens() {
    fetch('/funds/download-tokens')
        .then(response => response.json())
        .then(tokens => {
            currentTokenVersion = tokens.version;
            updateDownloadLinks(tokens);
        })
        .catch(error => console.error('Error fetching download tokens:', error));
}

// Check if token version has changed
function checkTokenVersion() {
    fetch('/funds/token-version')
        .then(response => response.json())
        .then(data => {
            if (data.version !== currentTokenVersion) {
                console.log('Token version changed from', currentTokenVersion, 'to', data.version);
                fetchAndUpdateTokens();
            }
        })
        .catch(error => console.error('Error checking token version:', error));
}

// Sorting function
function sortFunds(funds, column, direction) {
    return funds.sort((a, b) => {
        let aVal = a[column];
        let bVal = b[column];

        // Handle null/empty values
        if (aVal === null || aVal === undefined) aVal = '';
        if (bVal === null || bVal === undefined) bVal = '';

        // Numeric comparison for decimal fields
        if (column === 'NavPrice' || column === 'MarketPrice') {
            const aNum = parseFloat(aVal) || 0;
            const bNum = parseFloat(bVal) || 0;
            return direction === 'asc' ? aNum - bNum : bNum - aNum;
        }

        // String comparison for text fields
        aVal = String(aVal).toLowerCase();
        bVal = String(bVal).toLowerCase();

        if (direction === 'asc') {
            return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
        } else {
            return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
        }
    });
}

// Render table body
function renderTableBody() {
    const tbody = document.getElementById('funds-table-body');
    tbody.innerHTML = '';

    // Sort the data
    let sortedFunds = sortFunds([...allFunds], sortColumn, sortDirection);

    // Paginate
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = startIndex + pageSize;
    const paginatedFunds = sortedFunds.slice(startIndex, endIndex);

    // Render rows
    paginatedFunds.forEach(fund => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${fund.FundName}</td>
            <td class="text-center">${fund.TickerCode}</td>
            <td class="text-center">${fund.NavPrice}</td>
            <td class="text-center">${fund.MarketPrice}</td>
            <td class="text-center">${fund.HoldInTrust || ''}</td>
        `;
        tbody.appendChild(row);
    });

    // Update pagination info
    const totalItems = allFunds.length;
    const showingStart = totalItems === 0 ? 0 : startIndex + 1;
    const showingEnd = Math.min(endIndex, totalItems);
    document.getElementById('pagination-info').textContent =
        `Showing ${showingStart}-${showingEnd} of ${totalItems} entries`;

    // Update sort indicators
    document.querySelectorAll('.sortable-column').forEach(th => {
        th.classList.remove('sort-asc', 'sort-desc');
        if (th.dataset.column === sortColumn) {
            th.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
        }
    });

    renderPaginationControls(totalItems);
}

// Render pagination controls
function renderPaginationControls(totalItems) {
    const totalPages = Math.ceil(totalItems / pageSize);
    const pagination = document.getElementById('pagination-controls');
    pagination.innerHTML = '';

    // Previous button
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>`;
    pagination.appendChild(prevLi);

    // Page numbers (show max 5 pages)
    let startPage = Math.max(1, currentPage - 2);
    let endPage = Math.min(totalPages, startPage + 4);
    startPage = Math.max(1, endPage - 4);

    for (let i = startPage; i <= endPage; i++) {
        const pageLi = document.createElement('li');
        pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
        pageLi.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
        pagination.appendChild(pageLi);
    }

    // Next button
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>`;
    pagination.appendChild(nextLi);
}

// Handle sort click
document.addEventListener('click', function(e) {
    const sortableColumn = e.target.closest('.sortable-column');
    if (sortableColumn) {
        e.preventDefault();
        const column = sortableColumn.dataset.column;

        if (sortColumn === column) {
            // Toggle direction
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            // New column, default to ascending
            sortColumn = column;
            sortDirection = 'asc';
        }

        currentPage = 1; // Reset to first page when sorting
        renderTableBody();
    }

    // Handle pagination click
    const pageLink = e.target.closest('.page-link');
    if (pageLink && pageLink.dataset.page) {
        e.preventDefault();
        const newPage = parseInt(pageLink.dataset.page);
        const totalPages = Math.ceil(allFunds.length / pageSize);

        if (newPage >= 1 && newPage <= totalPages) {
            currentPage = newPage;
            renderTableBody();
        }
    }
});

// Handle page size change
document.addEventListener('change', function(e) {
    if (e.target.id === 'page-size-select') {
        pageSize = parseInt(e.target.value);
        currentPage = 1;
        renderTableBody();
    }
});

// Function to reload the funds table with API key authentication
function reloadFundsTable() {
    fetchApiKey().then(apiKey => {
        if (!apiKey) {
            console.error('No API key available');
            return;
        }

        fetch('/funds/update-table', {
            headers: {
                'X-API-Key': apiKey
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to update table: ' + response.status);
                }
                return response.text();
            })
            .then(html => {
                document.getElementById('funds-table-container').innerHTML = html;
                // Re-initialize data and render
                const dataElement = document.getElementById('funds-table-container');
                const fundsMatch = html.match(/allFunds = (\[.*?\]);/);
                if (fundsMatch) {
                    allFunds = JSON.parse(fundsMatch[1]);
                    renderTableBody();
                }
                // Re-fetch tokens after table reload
                fetchAndUpdateTokens();
            })
            .catch(error => console.error('Error reloading funds table:', error));
    });
}

// Initialize: fetch API key, tokens, and render table
fetchApiKey().then(() => {
    fetchAndUpdateTokens();
    renderTableBody();
});

// Poll for token version changes every 30 seconds
setInterval(checkTokenVersion, 30000);

// Reload funds table every 15 minutes
setInterval(reloadFundsTable, 15 * 60 * 1000);
</script>
