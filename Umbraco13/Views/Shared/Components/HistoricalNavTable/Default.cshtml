@model Umbraco13.Models.FundHistoricalNavViewModel

@{
    var historicalNavsData = System.Text.Json.JsonSerializer.Serialize(Model.HistoricalNavs);
}

<div id="historical-nav-container" style="margin: 40px auto 0 auto; width: 100%; max-width: 100%;">
    <h3 style="margin-bottom: 20px;">Historical NAV Values - @Model.FundName (@Model.TickerCode)</h3>

    @if (Model.HistoricalNavs != null && Model.HistoricalNavs.Count > 0)
    {
        <!-- Download Buttons -->
        <div style="display: flex; align-items: center; margin-bottom: 15px;">
            <div style="margin-right: auto;">
                <button id="sort-toggle-btn" class="btn btn-sm btn-secondary" type="button" style="margin-right: 10px;">
                    Sort: Newest First <span id="sort-indicator">↓</span>
                </button>
            </div>
            <div>
                <a href="#" id="download-hist-pdf" class="btn btn-danger" style="text-decoration: none; margin-right: 10px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-pdf" viewBox="0 0 16 16" style="margin-right: 5px; vertical-align: text-bottom;">
                        <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
                    </svg>
                    Download PDF
                </a>
                <a href="#" id="download-hist-excel" class="btn btn-success" style="text-decoration: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-excel" viewBox="0 0 16 16" style="margin-right: 5px; vertical-align: text-bottom;">
                        <path d="M5.884 6.68a.5.5 0 1 0-.768.64L7.349 10l-2.233 2.68a.5.5 0 0 0 .768.64L8 10.78l2.116 2.54a.5.5 0 0 0 .768-.641L8.651 10l2.233-2.68a.5.5 0 0 0-.768-.64L8 9.22 5.884 6.68z"/>
                        <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
                    </svg>
                    Download Excel
                </a>
            </div>
        </div>

        <!-- SVG Composite Bar Chart -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title text-center mb-4">NAV Price vs Market Price Chart</h5>
                <div id="nav-chart-container" style="width: 100%; overflow-x: auto; position: relative;">
                    <svg id="nav-chart" width="100%" height="350" preserveAspectRatio="xMidYMid meet" style="background-color: #f8f9fa; border-radius: 8px; min-width: 600px;">
                        <!-- Chart will be rendered here by JavaScript -->
                    </svg>
                    <div id="chart-tooltip"></div>
                </div>
                <!-- Legend -->
                <div class="text-center mt-3">
                    <span class="me-4">
                        <svg width="16" height="16" style="display: inline-block; vertical-align: middle; margin-right: 5px;">
                            <rect width="16" height="16" fill="#3b82f6" rx="2"/>
                        </svg>
                        NAV Price
                    </span>
                    <span>
                        <svg width="16" height="16" style="display: inline-block; vertical-align: middle; margin-right: 5px;">
                            <rect width="16" height="16" fill="#22c55e" rx="2"/>
                        </svg>
                        Market Price
                    </span>
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-hover" id="historical-nav-table">
                <thead class="table-light" id="historical-nav-table-head">
                    <!-- Date columns will be populated by JavaScript -->
                </thead>
                <tbody id="historical-nav-table-body">
                    <!-- Field rows will be populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Pagination Controls -->
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div>
                <span id="hist-pagination-info">Showing 1-5 of @Model.TotalItems dates</span>
            </div>
            <nav aria-label="Page navigation">
                <ul class="pagination mb-0" id="hist-pagination-controls">
                    <!-- Pagination buttons will be populated by JavaScript -->
                </ul>
            </nav>
        </div>

        <!-- Page Size Selector -->
        <div class="mt-3 text-end">
            <label>Show
                <select id="hist-page-size-select" class="form-select form-select-sm d-inline-block" style="width: auto;">
                    <option value="3">3</option>
                    <option value="5" selected>5</option>
                    <option value="10">10</option>
                    <option value="20">20</option>
                </select>
                dates per page
            </label>
        </div>
    }
    else
    {
        <p class="text-muted">No historical NAV data available for this fund.</p>
    }
</div>

<style>
.pagination .page-link {
    cursor: pointer;
}

.pagination .page-item.disabled .page-link {
    cursor: not-allowed;
}

.positive-change {
    color: green;
}

.negative-change {
    color: red;
}

.sort-toggle-btn {
    margin-left: auto;
    margin-right: 20px;
}

/* Chart styles */
.chart-bar {
    transition: opacity 0.2s ease;
    cursor: pointer;
}

.chart-bar:hover {
    opacity: 0.7;
}

#chart-tooltip {
    position: absolute;
    background-color: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 12px;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s ease;
    z-index: 1000;
    white-space: nowrap;
}

#chart-tooltip.show {
    opacity: 1;
}
</style>

<script>
(function() {
    // Data and state
    let allHistoricalNavs = @Html.Raw(historicalNavsData);
    let currentPage = 1;
    let pageSize = 5;
    let sortDirection = 'desc'; // Sort by date (newest first)

    // Define rows and their display order
    const fieldRows = [
        { key: 'NavPrice', label: 'NAV Price', format: 'currency', align: 'center' },
        { key: 'MarketPrice', label: 'Market Price', format: 'currency', align: 'center' },
        { key: 'DailyChangePercent', label: 'Daily Change %', format: 'percent', align: 'center' },
        { key: 'NetAssetValue', label: 'Net Asset Value (M)', format: 'currency', align: 'center' }
    ];

    // Sort by date
    function sortHistoricalNavs(navData, direction) {
        return navData.sort((a, b) => {
            const dateA = new Date(a.NavDate);
            const dateB = new Date(b.NavDate);
            return direction === 'asc' ? dateA - dateB : dateB - dateA;
        });
    }

    // Format date
    function formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-GB');
    }

    // Format currency
    function formatCurrency(value) {
        return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value);
    }

    // Format percentage
    function formatPercentage(value) {
        return value.toFixed(2) + '%';
    }

    // Get formatted value
    function getFormattedValue(value, format) {
        switch (format) {
            case 'currency':
                return formatCurrency(value);
            case 'percent':
                const formatted = formatPercentage(value);
                const sign = value >= 0 ? '+' : '';
                const colorClass = value >= 0 ? 'positive-change' : 'negative-change';
                return { text: sign + formatted, class: colorClass };
            default:
                return value;
        }
    }

    // Render SVG composite bar chart
    function renderChart(paginatedNavs) {
        const svg = document.getElementById('nav-chart');
        if (!svg || paginatedNavs.length === 0) {
            if (svg) {
                svg.setAttribute('viewBox', '0 0 600 350');
                svg.innerHTML = '<text x="300" y="175" text-anchor="middle" fill="#6c757d">No data available</text>';
            }
            return;
        }

        // Table column dimensions (matching table structure exactly)
        const labelColumnWidth = 150;  // Width of label column in table
        const dateColumnWidth = 120;   // Width of each date column in table

        // Calculate total width to match table exactly
        const totalWidth = labelColumnWidth + (paginatedNavs.length * dateColumnWidth);
        const height = 350;

        // Set viewBox to match table width exactly
        svg.setAttribute('viewBox', `0 0 ${totalWidth} ${height}`);

        // Chart padding - Y axis fits within the label column space
        const yAxisWidth = 50;  // Space for Y axis labels
        const padding = { top: 40, right: 20, bottom: 70, left: yAxisWidth };
        const chartWidth = totalWidth - padding.left - padding.right;
        const chartHeight = height - padding.top - padding.bottom;

        // Clear previous content
        svg.innerHTML = '';

        // Find min and max values for Y axis scale
        let allValues = [];
        paginatedNavs.forEach(nav => {
            allValues.push(nav.NavPrice, nav.MarketPrice);
        });
        const minValue = Math.min(...allValues) * 0.95;
        const maxValue = Math.max(...allValues) * 1.05;
        const valueRange = maxValue - minValue;

        // Calculate bar dimensions - match table column width exactly
        const barWidth = 40;  // Fixed width for each bar
        const barGap = 8;     // Gap between bars in same group

        // Create SVG namespace
        const ns = 'http://www.w3.org/2000/svg';

        // Function to convert value to Y coordinate
        const valueToY = (value) => {
            return padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
        };

        // Function to convert index to X coordinate for bar group (align with table columns)
        // Bar groups start at labelColumnWidth (150px) and each column is dateColumnWidth (120px)
        const indexToGroupX = (index) => {
            return labelColumnWidth + (index * dateColumnWidth) + (dateColumnWidth / 2);
        };

        // Draw Y axis grid lines and labels
        const gridLineCount = 5;
        for (let i = 0; i <= gridLineCount; i++) {
            const value = minValue + (valueRange * i / gridLineCount);
            const y = valueToY(value);

            // Grid line - spans from Y axis to right edge
            const line = document.createElementNS(ns, 'line');
            line.setAttribute('x1', padding.left);
            line.setAttribute('y1', y);
            line.setAttribute('x2', totalWidth - padding.right);
            line.setAttribute('y2', y);
            line.setAttribute('stroke', '#e0e0e0');
            line.setAttribute('stroke-width', '1');
            line.setAttribute('stroke-dasharray', '4,4');
            svg.appendChild(line);

            // Y axis label
            const label = document.createElementNS(ns, 'text');
            label.setAttribute('x', padding.left - 8);
            label.setAttribute('y', y + 4);
            label.setAttribute('text-anchor', 'end');
            label.setAttribute('font-size', '11');
            label.setAttribute('fill', '#6c757d');
            label.textContent = '$' + value.toFixed(2);
            svg.appendChild(label);
        }

        // Draw vertical divider line between label column and date columns
        const dividerLine = document.createElementNS(ns, 'line');
        dividerLine.setAttribute('x1', labelColumnWidth);
        dividerLine.setAttribute('y1', padding.top - 10);
        dividerLine.setAttribute('x2', labelColumnWidth);
        dividerLine.setAttribute('y2', height - padding.bottom);
        dividerLine.setAttribute('stroke', '#dee2e6');
        dividerLine.setAttribute('stroke-width', '2');
        svg.appendChild(dividerLine);

        // Draw bars and X axis labels
        paginatedNavs.forEach((nav, index) => {
            const groupX = indexToGroupX(index);

            // NAV Price bar (blue) - left bar in group
            const navPriceY = valueToY(nav.NavPrice);
            const navPriceHeight = padding.top + chartHeight - navPriceY;
            const navBar = document.createElementNS(ns, 'rect');
            navBar.setAttribute('x', groupX - barWidth - (barGap / 2));
            navBar.setAttribute('y', navPriceY);
            navBar.setAttribute('width', barWidth);
            navBar.setAttribute('height', navPriceHeight);
            navBar.setAttribute('fill', '#3b82f6');
            navBar.setAttribute('rx', '3');
            navBar.setAttribute('class', 'chart-bar');
            navBar.setAttribute('data-value', nav.NavPrice.toFixed(2));
            navBar.setAttribute('data-type', 'NAV Price');
            svg.appendChild(navBar);

            // Market Price bar (green) - right bar in group
            const marketPriceY = valueToY(nav.MarketPrice);
            const marketPriceHeight = padding.top + chartHeight - marketPriceY;
            const marketBar = document.createElementNS(ns, 'rect');
            marketBar.setAttribute('x', groupX + (barGap / 2));
            marketBar.setAttribute('y', marketPriceY);
            marketBar.setAttribute('width', barWidth);
            marketBar.setAttribute('height', marketPriceHeight);
            marketBar.setAttribute('fill', '#22c55e');
            marketBar.setAttribute('rx', '3');
            marketBar.setAttribute('class', 'chart-bar');
            marketBar.setAttribute('data-value', nav.MarketPrice.toFixed(2));
            marketBar.setAttribute('data-type', 'Market Price');
            svg.appendChild(marketBar);

            // X axis label (date)
            const dateLabel = document.createElementNS(ns, 'text');
            dateLabel.setAttribute('x', groupX);
            dateLabel.setAttribute('y', height - padding.bottom + 25);
            dateLabel.setAttribute('text-anchor', 'middle');
            dateLabel.setAttribute('font-size', '12');
            dateLabel.setAttribute('font-weight', '500');
            dateLabel.setAttribute('fill', '#495057');
            dateLabel.textContent = formatDate(nav.NavDate);
            svg.appendChild(dateLabel);
        });

        // Draw Y axis line
        const yAxis = document.createElementNS(ns, 'line');
        yAxis.setAttribute('x1', padding.left);
        yAxis.setAttribute('y1', padding.top);
        yAxis.setAttribute('x2', padding.left);
        yAxis.setAttribute('y2', height - padding.bottom);
        yAxis.setAttribute('stroke', '#495057');
        yAxis.setAttribute('stroke-width', '2');
        svg.appendChild(yAxis);

        // Draw X axis line
        const xAxis = document.createElementNS(ns, 'line');
        xAxis.setAttribute('x1', padding.left);
        xAxis.setAttribute('y1', height - padding.bottom);
        xAxis.setAttribute('x2', totalWidth - padding.right);
        xAxis.setAttribute('y2', height - padding.bottom);
        xAxis.setAttribute('stroke', '#495057');
        xAxis.setAttribute('stroke-width', '2');
        svg.appendChild(xAxis);

        // Y axis title (rotated)
        const yAxisTitle = document.createElementNS(ns, 'text');
        yAxisTitle.setAttribute('x', -height / 2);
        yAxisTitle.setAttribute('y', 15);
        yAxisTitle.setAttribute('transform', 'rotate(-90)');
        yAxisTitle.setAttribute('text-anchor', 'middle');
        yAxisTitle.setAttribute('font-size', '12');
        yAxisTitle.setAttribute('font-weight', 'bold');
        yAxisTitle.setAttribute('fill', '#495057');
        yAxisTitle.textContent = 'Price (USD)';
        svg.appendChild(yAxisTitle);

        // Add tooltip event listeners
        setupChartTooltips(svg, paginatedNavs);
    }

    // Setup tooltip functionality for chart bars
    function setupChartTooltips(svg, navData) {
        const tooltip = document.getElementById('chart-tooltip');
        if (!tooltip) return;

        const bars = svg.querySelectorAll('.chart-bar');
        bars.forEach(bar => {
            bar.addEventListener('mouseenter', function(e) {
                const value = this.getAttribute('data-value');
                const type = this.getAttribute('data-type');
                const fill = this.getAttribute('fill');
                const color = fill === '#3b82f6' ? '#3b82f6' : '#22c55e';
                tooltip.innerHTML = `<strong style="color: ${color}">${type}</strong><br>$${value}`;
                tooltip.classList.add('show');
            });

            bar.addEventListener('mousemove', function(e) {
                const container = document.getElementById('nav-chart-container');
                const rect = container.getBoundingClientRect();
                tooltip.style.left = (e.clientX - rect.left + 10) + 'px';
                tooltip.style.top = (e.clientY - rect.top - 40) + 'px';
            });

            bar.addEventListener('mouseleave', function() {
                tooltip.classList.remove('show');
            });
        });
    }

    // Render table header (dates as columns)
    function renderTableHeader(paginatedNavs) {
        const thead = document.getElementById('historical-nav-table-head');
        thead.innerHTML = '';

        // Create header row
        const headerRow = document.createElement('tr');

        // First cell is empty (row labels column)
        const emptyTh = document.createElement('th');
        emptyTh.className = 'table-light';
        emptyTh.style.width = '150px';
        headerRow.appendChild(emptyTh);

        // Add date columns
        paginatedNavs.forEach(nav => {
            const th = document.createElement('th');
            th.className = 'table-light text-center';
            th.style.minWidth = '120px';
            th.textContent = formatDate(nav.NavDate);
            headerRow.appendChild(th);
        });

        thead.appendChild(headerRow);
    }

    // Render table body (fields as rows)
    function renderTableBody() {
        const tbody = document.getElementById('historical-nav-table-body');
        tbody.innerHTML = '';

        if (allHistoricalNavs.length === 0) {
            tbody.innerHTML = '<tr><td class="text-center text-muted" colspan="10">No data available</td></tr>';
            return;
        }

        // Sort by date
        let sortedNavs = sortHistoricalNavs([...allHistoricalNavs], sortDirection);

        // Paginate
        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = startIndex + pageSize;
        const paginatedNavs = sortedNavs.slice(startIndex, endIndex);

        // Render header with dates
        renderTableHeader(paginatedNavs);

        // Render chart
        renderChart(paginatedNavs);

        // Render each field as a row
        fieldRows.forEach(field => {
            const row = document.createElement('tr');

            // First cell is the field label
            const labelCell = document.createElement('td');
            labelCell.textContent = field.label;
            labelCell.style.fontWeight = 'bold';
            labelCell.style.textAlign = 'center';
            row.appendChild(labelCell);

            // Add values for each date
            paginatedNavs.forEach(nav => {
                const cell = document.createElement('td');
                cell.className = `text-${field.align}`;

                const value = nav[field.key];
                if (field.format === 'percent') {
                    const result = getFormattedValue(value, field.format);
                    cell.innerHTML = `<span class="${result.class}">${result.text}</span>`;
                } else {
                    cell.textContent = getFormattedValue(value, field.format);
                }

                row.appendChild(cell);
            });

            tbody.appendChild(row);
        });

        // Update pagination info
        const totalItems = allHistoricalNavs.length;
        const showingStart = totalItems === 0 ? 0 : startIndex + 1;
        const showingEnd = Math.min(endIndex, totalItems);
        document.getElementById('hist-pagination-info').textContent =
            `Showing ${showingStart}-${showingEnd} of ${totalItems} dates`;

        renderPaginationControls(totalItems);
    }

    // Render pagination controls
    function renderPaginationControls(totalItems) {
        const totalPages = Math.ceil(totalItems / pageSize);
        const pagination = document.getElementById('hist-pagination-controls');

        if (!pagination) return;

        pagination.innerHTML = '';

        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>`;
        pagination.appendChild(prevLi);

        // Page numbers
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, startPage + 4);
        startPage = Math.max(1, endPage - 4);

        for (let i = startPage; i <= endPage; i++) {
            const pageLi = document.createElement('li');
            pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
            pageLi.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
            pagination.appendChild(pageLi);
        }

        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>`;
        pagination.appendChild(nextLi);
    }

    // Toggle sort direction
    function toggleSort() {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        currentPage = 1;
        renderTableBody();
        updateSortButton();
    }

    // Update sort button display
    function updateSortButton() {
        const btn = document.getElementById('sort-toggle-btn');
        const indicator = document.getElementById('sort-indicator');
        if (btn && indicator) {
            if (sortDirection === 'desc') {
                btn.textContent = 'Sort: Newest First ';
                indicator.textContent = '↓';
            } else {
                btn.textContent = 'Sort: Oldest First ';
                indicator.textContent = '↑';
            }
        }
    }

    // Event listeners
    document.addEventListener('click', function(e) {
        // Handle sort toggle button
        if (e.target.closest('#sort-toggle-btn')) {
            e.preventDefault();
            toggleSort();
            return;
        }

        // Handle pagination click
        const pageLink = e.target.closest('.page-link');
        if (pageLink && pageLink.dataset.page) {
            e.preventDefault();
            const newPage = parseInt(pageLink.dataset.page);
            const totalPages = Math.ceil(allHistoricalNavs.length / pageSize);

            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderTableBody();
            }
        }
    });

    document.addEventListener('change', function(e) {
        if (e.target.id === 'hist-page-size-select') {
            pageSize = parseInt(e.target.value);
            currentPage = 1;
            renderTableBody();
        }
    });

    // Update download links when tokens are fetched
    function updateHistoricalDownloadLinks(tokens) {
        const fundId = @Model.FundId;
        document.getElementById('download-hist-pdf').href = `/funds/historical-nav-pdf/${fundId}?token=${tokens.pdf}`;
        document.getElementById('download-hist-excel').href = `/funds/historical-nav-excel/${fundId}?token=${tokens.excelGeneric}`;
    }

    // Listen for token updates from main page
    if (window.updateHistoricalDownloadLinks) {
        window.updateHistoricalDownloadLinks = updateHistoricalDownloadLinks;
    }

    // Initial render
    renderTableBody();
    updateSortButton();
})();
</script>
